<!-- Chris He, 2022 -->
<!-- chris@maigod.net -->
<!-- Potential Features to be Added: -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laundry Management Tool</title>
    <link rel = "stylesheet" href = "Resource/css/style.css">
    <link rel = "stylesheet" href = "Resource/css/login.css">
    <link rel = "stylesheet" href = "Resource/css/footer.css">
    <link rel = "stylesheet" href = "Resource/css/management.css">
    <link rel = "stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js" integrity="sha512-M72KfQy4kPuLYC6CeTrN0eA17U1lXEMrr5qEJC/40CLdZGC3HpwPS0esQLqBHnxty2FIcuNdP9EqwSOCLEVJXQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>
<body>
    <div id = "bbContainer">
        <!--------------------------------------------header---------------------------------------------------------------->
        <div id="header_container"></div>

        <!--------------------------------------------body---------------------------------------------------------------->
        <div id="createMachineContainer">
             <span id = "createMachineText" class = "createButton" onclick= show_create_option()>Create Machine</span>
        </div>

        <div id="createMachineTypeContainer">
            <div class="createMachineType createButton" id = "wash" onclick = show_time(this)>Create Laundry Machine</div>
            <div class="createMachineType createButton" id = "dry" onclick = show_time(this)>Create Dryer</div>
            <div class="createMachineType createButton" id = "other" onclick = show_time(this)>Create Other Machine</div>
        </div>

        <div class="createWashMachineTimeContainer" id ="washTime" data-type = "wash">
            <div class="machineTime">15 min</div>
            <div class="machineTime">30 min</div>
            <div class="machineTime">45 min</div>
            <div class="machineTime">60 min</div>
            <div class="machineTime">90 min</div>
            <div class="machineTime">120 min</div>
        </div>

        <div class="createWashMachineTimeContainer" id ="dryTime" data-type = "dry">
            <div class="machineTime">15 min</div>
            <div class="machineTime">30 min</div>
            <div class="machineTime">45 min</div>
            <div class="machineTime">60 min</div>
            <div class="machineTime">90 min</div>
            <div class="machineTime">120 min</div>
        </div>

        <div class="createWashMachineTimeContainer" id ="otherTime" data-type = "other">
            <div class="machineTime">15 min</div>
            <div class="machineTime">30 min</div>
            <div class="machineTime">45 min</div>
            <div class="machineTime">60 min</div>
            <div class="machineTime">90 min</div>
            <div class="machineTime">120 min</div>
        </div>

        

        <div id="article">

            <!-- -----------------------Overall Status Box----------------------------- -->
            <div class = "secLvContainer" id="statusContainer" >
                <div class="secLvContainerTitle">
                    Overall Status
                </div>

                <div id="statusBarContainer">

                    <div class="barContainer">
                        <span class="chartText" >Laundry Machine</span>
                        
                        <div class="chart">
                            <div class="bar"></div>
                            <!-- Change the value below -->
                        </div>
                        <span class="value1"></span>
                    </div>

                    <div class="barContainer">
                        <span class="chartText">Dryer</span>
                        <div class="chart">
                            <div class="bar"></div>
                            <!-- Change the value below -->
                        </div>
                        <span class="value1"></span>
                    </div>

                    <div class="barContainer">
                        <span class="chartText">Other Machine</span>
                        <div class="chart">
                            <div class="bar"></div>
                            <!-- Change the value below -->

                        </div>
                        <span class="value1"></span>
                    </div>

                </div>
            </div>

            <!-- -----------------------Graphic View Box----------------------------- -->
            <div class = "secLvContainer" id="washContainer" >
                <div class="secLvContainerTitle">
                    Graphic view
                </div>

                <div id="GraphicViewContainer">

                    <div class="machineSection">
                        <div class="graphicViewTypeText">
                            Laundry Machine
                        </div>

                        <div class="machineContainer">
                            <div class="graphicViewText">
                                available:
                            </div>
                            <div class="avaSection" id = "washAvaSec">

                            </div>
                        </div>
                        <div class="machineContainer">
                            <div class="graphicViewText">
                                unavailable:
                            </div>
                            <div class="unavaSection" id = "washUnAvaSec">

                            </div>
                        </div>
                    </div>

                    <div class="machineSection">

                        <div class="graphicViewTypeText">
                            Dryer
                        </div>

                        <div class="machineContainer">
                            <div class="graphicViewText">
                                available:
                            </div>
                            <div class="avaSection" id = "dryAvaSec">

                                
                            </div>
                        </div>
                        <div class="machineContainer">
                            <div class="graphicViewText">
                                unavailable:
                            </div>
                            <div class="unavaSection" id = "dryUnAvaSec">

                            </div>
                        </div>
                    </div>

                    <div class="machineSection">

                        <div class="graphicViewTypeText">
                            Other Machine
                        </div>

                        <div class="machineContainer">
                            <div class="graphicViewText">
                                available:
                            </div>
                            <div class="avaSection" id = "otherAvaSec">
                                <!-- <div class="imgContainer hoverAva">
                                    <img src="Resource/imgs/LM.svg" class="lm">
                                    <div class="middle">
                                        <div class="text">John Doe</div>
                                    </div>
                                </div> -->

                            </div>
                        </div>
                        <div class="machineContainer">
                            <div class="graphicViewText">
                                unavailable:
                            </div>
                            <div class="unavaSection" id = "otherUnAvaSec">
                            </div>
                        </div>
                    </div>


                </div>
            </div>
            <!-- ---------------------------------------------------- -->
        </div>

        <!--------------------------------------------footer---------------------------------------------------------------->
        <div id = "footer_container"></div>
        
    </div>
    <div id="bg-model"></div>
    <script type="text/javascript" src="Resource/js/jquery-3.6.1.min.js"></script>
    <script>
        
        // ---------------------------------------------------------------------------------------------
        // Animation for status bar
        function increase(perc) {
            //change status bar fill percentage
            let bars = document.getElementsByClassName("bar");
            for(let i = 0; i < bars.length; i++){
                bars[i].style.setProperty('--m',perc[i].toString()+"%");
            }
            
            // Change the variable to modify the speed of the number increasing from 0 to (ms)
            let SPEED = 30;
            // Retrieve the percentage value
            let limitList = [];
            let barList = document.getElementsByClassName("value1");
            for(let i = 0; i < barList.length; i++){
                barList[i].innerHTML = perc[i];
                parseInt(limitList.push(barList[i].innerHTML),10);
            }

            for(let j = 0; j < limitList.length; j++){
                for(let i = 0; i <= limitList[j]; i++) {
                    setTimeout(function () {
                        document.getElementsByClassName("value1")[j].innerHTML = i + "%";
                    }, SPEED * i);
                }
            }
        }



        // ---------------------------------------------------------------------------------------------
        function show_create_option(){
            document.querySelectorAll(".createMachineType").forEach(div => {
                let currentDisplay = getComputedStyle(div).getPropertyValue('display');
                if(currentDisplay == "flex"){div.style.display = "none";}
                if(currentDisplay == "none"){div.style.display = "flex";}
            })

        }

        // ---------------------------------------------------------------------------------------------
        function has_logged_in(){
            $.ajax({
                type: "GET",
                url:"http://127.0.0.1:5000/loggedin",
                success:function(msg){
                    console.log(msg);
                }
            })
        }
        
        // ---------------------------------------------------------------------------------------------
        function show_time(ele){
            
            //reset all color to white
            document.querySelectorAll(".createButton").forEach(div => {
                div.style.color = "white";
            })
            
            //set selected color to different color
            ele.style.color = "#b7e1cc";

            //reset all time button
            document.querySelectorAll(".createWashMachineTimeContainer").forEach(div => {
                div.style.display = "none";
            })

            //display selected time options
            document.getElementById(ele.id + "Time").style.display = "flex";
        }
        
        // ---------------------------------------------------------------------------------------------
        document.querySelectorAll(".createWashMachineTimeContainer").forEach(div => {
            div.addEventListener("click",function(event){
                let typeOfMachine = event.target.parentNode.getAttribute("data-type"); //e.g. wash dry other
                let time = event.target.innerHTML.slice(0,-3); //e.g. 15 30 45... 

                new_machine_helper(typeOfMachine,time);
            })
        })

        // ---------------------------------------------------------------------------------------------
        function new_machine_helper(type,time){
            $.ajax({
                type: "GET",
                url:"http://127.0.0.1:5000/getsite",
                success:function(msg){
                    var site = msg["site"]; 

                    new_machine(site,type,time)
                }
            })
        }

        // ---------------------------------------------------------------------------------------------
        function get_machine_helper(){
            $.ajax({
                type: "GET",
                url:"http://127.0.0.1:5000/getsite",
                success:function(msg){
                    var site = msg["site"]; 
                    console.log(site);
                    get_machines(site);

                }
            })
        }

        // ---------------------------------------------------------------------------------------------
        function addmachineToHtml(type, status){
            if (type == 1) {type = "wash"};
            if (type == 2) {type = "dry"};
            if (type == 3) {type = "other"};

            if (status == "0") {status = "Ava"}
            else{
                status = "UnAva";
            }
            // if (status != "0") {status = "UnAva"};

            let domId = type + status +"Sec";

            console.log(domId);
            

            $("#"+ domId).append('<div class="imgContainer hoverAva">' +
                                '<img src="Resource/imgs/LM.svg" class="lm">'+
                                '<div class="middle">' +
                                    '<div class="text">avalible</div>' +
                                '</div>' +
                            '</div>');

            



        }

        // ---------------------------------------------------------------------------------------------
        // when hover over machine, show how much time is left
        // list = [w,d,o],  each represents an array of machine, 0 is ava, any number above 0 means time left in seconds 

        function add_hover(list){
            // let washUnava = list[0].filter(e => e!==0);
            // let dryUnava = list[1].filter(e => e!==0);
            // let otherUnava = list[2].filter(e => e!==0);

            for(let i = 0; i < list.length; i++){
                let Unava = list[i].filter(e => e!==0);

                for(let j = 0; j < Unava.length; j++){
                    let targetedElement = document.getElementsByClassName("unavaSection")[i].children[j].children[1].innerHTML = Unava[j] + "s";

                    // console.log(targetedElement.children[j].children[1].innerHTML);
                }
            }
            
            // console.log(document.getElementsByClassName("unavaSection")[1].children[0].children[1]);
        }

        // ---------------------------------------------------------------------------------------------
        function get_machines(site){
            let washStatus = [];
            let dryStatus = [];
            let otherStatus = [];

            let url = "http://127.0.0.1:5000/dashboard?site=" + site;
            $.ajax({
                type: "POST",
                url:"http://127.0.0.1:5000/dashboard?site=" + site,
                success:function(msg){
                    for( i in msg){
                        if(i == "site"){continue;}
                        let machineId = i;
                        let status = msg[i];
                        let machineType = String(machineId)[0]; //if the first digit is a 1, it is a washer, if it is a 2, it is a drier, if it is a 3
                        
                        if(machineType == "1" && status == 0){washStatus.push(0)};
                        if(machineType == "1" && status != 0){washStatus.push(parseInt(status))};
                        if(machineType == "2" && status == 0){dryStatus.push(0)};
                        if(machineType == "2" && status != 0){dryStatus.push(parseInt(status))};
                        if(machineType == "3" && status == 0){otherStatus.push(0)};
                        if(machineType == "3" && status != 0){otherStatus.push(parseInt(status))};

                        addmachineToHtml(machineType,status);
                    }
                    
                    //add hover effect
                    add_hover([washStatus,dryStatus,otherStatus]);
                    // console.log(washStatus);
                    // console.log(dryStatus);
                    // console.log(otherStatus);

                    let washPerc = washStatus.filter(x => x === 0).length/washStatus.length*100;
                    let dryPerc = dryStatus.filter(x => x === 0).length/dryStatus.length*100;
                    let otherPerc = otherStatus.filter(x => x === 0).length/otherStatus.length*100;

                    increase([washPerc,dryPerc,otherPerc]);
                }
            })
        }

        // ---------------------------------------------------------------------------------------------
        function new_machine(site,type,time){
            console.log("http://127.0.0.1:5000/new-machine?time=" + time*60 + "&site="+ site+"&type=" + type);
            
            $.ajax({
                type: "POST",
                url:"http://127.0.0.1:5000/new-machine?time=" + time*60 + "&site="+ site+"&type=" + type,
                success:function(msg){
                    window.open("http://127.0.0.1:5500/backend/" + msg, '_blank').focus();
                }
            })
        }

        get_machine_helper();

        //honest attemp to convert to more readable time format
        // // ---------------------------------------------------------------------------------------------
        // // second to actual time
        // function fancyTimeFormat(duration)
        // {   
        //     // Hours, minutes and seconds
        //     var hrs = ~~(duration / 3600);
        //     var mins = ~~((duration % 3600) / 60);
        //     var secs = ~~duration % 60;

        //     // Output like "1:01" or "4:03:59" or "123:03:59"
        //     var ret = "";

        //     if (hrs > 0) {
        //         ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
        //     }

        //     ret += "" + mins + ":" + (secs < 10 ? "0" : "");
        //     ret += "" + secs;
        //     return ret;
        // }

        // // ---------------------------------------------------------------------------------------------
        // // reduce timer
        // let unAvaArray = [];
        // $(".middle").each(function() {
        //     // console.log($(this).text());
        //     if($(this).text() === "avalible"){;}
        //     else{
        //         var newValue = parseInt($(this).text(), 10);
        //         unAvaArray.push(newValue);
        //     }
        // });


        // setInterval(function(){
        //     document.getElementsByClassName("middle");
        //     for
        // })

        var timer = setInterval(function () {
            $(".middle").each(function() {
                // console.log($(this).text());
                if($(this).text() === "avalible"){;}
                else{
                    var newValue = parseInt($(this).text(), 10) - 1;
                    $(this).text(newValue + "s");
                    if(newValue == 0) {
                        location.reload();
                    }
                }
            });
        }, 1000);
    </script>

    <script type="text/javascript" src="Resource/js/script.js"></script>



</body>
</html>