<!-- Chris He, 2022 -->
<!-- chris@maigod.net -->
<!-- Potential Features to be Added: -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laundry Management Tool</title>
    <link rel = "stylesheet" href = "Resource/css/style.css">
    <link rel = "stylesheet" href = "Resource/css/login.css">
    <link rel = "stylesheet" href = "Resource/css/footer.css">
    <link rel = "stylesheet" href = "Resource/css/management.css">
    <link rel = "stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js" integrity="sha512-M72KfQy4kPuLYC6CeTrN0eA17U1lXEMrr5qEJC/40CLdZGC3HpwPS0esQLqBHnxty2FIcuNdP9EqwSOCLEVJXQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>
<body>
    <div id = "bbContainer">
        <!--------------------------------------------header---------------------------------------------------------------->
        <div id="header_container"></div>

        <!--------------------------------------------body---------------------------------------------------------------->
        <div id="createMachineContainer">
             <span id = "createMachineText" class = "createButton" onclick= show_create_option()>Create Machine</span>
        </div>

        <div id="createMachineTypeContainer">
            <div class="createMachineType createButton" id = "wash" onclick = new_machine_helper(this)>Create Laundry Machine</div>
            <div class="createMachineType createButton" id = "dry" onclick = new_machine_helper(this)>Create Dryer</div>
            <div class="createMachineType createButton" id = "other" onclick = new_machine_helper(this)>Create Other Machine</div>
        </div>

        <div id="article">

            <!-- -----------------------Overall Status Box----------------------------- -->
            <div class = "secLvContainer" id="statusContainer" >
                <div class="secLvContainerTitle">
                    Overall Status
                </div>

                <div id="statusBarContainer">

                    <div class="barContainer">
                        <span class="chartText" >Laundry Machine</span>
                        
                        <div class="chart">
                            <div class="bar"></div>
                            <!-- Change the value below -->
                        </div>
                        <span class="value1"></span>
                    </div>

                    <div class="barContainer">
                        <span class="chartText">Dryer</span>
                        <div class="chart">
                            <div class="bar"></div>
                            <!-- Change the value below -->
                        </div>
                        <span class="value1"></span>
                    </div>

                    <div class="barContainer">
                        <span class="chartText">Other Machine</span>
                        <div class="chart">
                            <div class="bar"></div>
                            <!-- Change the value below -->

                        </div>
                        <span class="value1"></span>
                    </div>

                </div>
            </div>

            <!-- -----------------------Graphic View Box----------------------------- -->
            <div class = "secLvContainer" id="washContainer" >
                <div class="secLvContainerTitle">
                    Graphic view
                </div>

                <div id="GraphicViewContainer">

                    <div class="machineSection">
                        <div class="graphicViewTypeText">
                            Laundry Machine
                        </div>

                        <div class="machineContainer">
                            <div class="graphicViewText">
                                available:
                            </div>
                            <div class="avaSection" id = "washAvaSec">

                            </div>
                        </div>
                        <div class="machineContainer">
                            <div class="graphicViewText">
                                unavailable:
                            </div>
                            <div class="unavaSection" id = "washUnAvaSec">

                            </div>
                        </div>
                    </div>

                    <div class="machineSection">

                        <div class="graphicViewTypeText">
                            Dryer
                        </div>

                        <div class="machineContainer">
                            <div class="graphicViewText">
                                available:
                            </div>
                            <div class="avaSection" id = "dryAvaSec">

                                
                            </div>
                        </div>
                        <div class="machineContainer">
                            <div class="graphicViewText">
                                unavailable:
                            </div>
                            <div class="unavaSection" id = "dryUnAvaSec">

                            </div>
                        </div>
                    </div>

                    <div class="machineSection">

                        <div class="graphicViewTypeText">
                            Other Machine
                        </div>

                        <div class="machineContainer">
                            <div class="graphicViewText">
                                available:
                            </div>
                            <div class="avaSection" id = "otherAvaSec">

                            </div>
                        </div>
                        <div class="machineContainer">
                            <div class="graphicViewText">
                                unavailable:
                            </div>
                            <div class="unavaSection" id = "otherUnAvaSec">
                            </div>
                        </div>
                    </div>


                </div>
            </div>
            <!-- ---------------------------------------------------- -->
        </div>

        <!--------------------------------------------footer---------------------------------------------------------------->
        <div id = "footer_container"></div>
        
    </div>
    <div id="bg-model"></div>
    <script type="text/javascript" src="Resource/js/jquery-3.6.1.min.js"></script>
    <script>
        
        // ---------------------------------------------------------------------------------------------
        // Animation for status bar
        function increase(perc) {
            //change status bar fill percentage
            let bars = document.getElementsByClassName("bar");
            for(let i = 0; i < bars.length; i++){
                bars[i].style.setProperty('--m',perc[i].toString()+"%");
            }
            
            // Change the variable to modify the speed of the number increasing from 0 to (ms)
            let SPEED = 30;
            // Retrieve the percentage value
            let limitList = [];
            let barList = document.getElementsByClassName("value1");
            for(let i = 0; i < barList.length; i++){
                barList[i].innerHTML = perc[i];
                parseInt(limitList.push(barList[i].innerHTML),10);
            }

            for(let j = 0; j < limitList.length; j++){
                for(let i = 0; i <= limitList[j]; i++) {
                    setTimeout(function () {
                        document.getElementsByClassName("value1")[j].innerHTML = i + "%";
                    }, SPEED * i);
                }
            }
        }



        // ---------------------------------------------------------------------------------------------
        function show_create_option(){
            document.querySelectorAll(".createMachineType").forEach(div => {
                let currentDisplay = getComputedStyle(div).getPropertyValue('display');
                if(currentDisplay == "flex"){div.style.display = "none";}
                if(currentDisplay == "none"){div.style.display = "flex";}
            })
        }

        // ---------------------------------------------------------------------------------------------
        function has_logged_in(){
            $.ajax({
                type: "GET",
                url:"http://127.0.0.1:5000/loggedin",
                success:function(msg){
                    console.log(msg);
                }
            })
        }
    
        // ---------------------------------------------------------------------------------------------
        function new_machine_helper(ele){
            $.ajax({
                type: "GET",
                url:"http://127.0.0.1:5000/getsite",
                success:function(msg){
                    var site = msg["site"]; 
                    new_machine(site,ele)
                }
            })
        }

        // ---------------------------------------------------------------------------------------------
        function get_machine_helper(){
            $.ajax({
                type: "GET",
                url:"http://127.0.0.1:5000/getsite",
                success:function(msg){
                    var site = msg["site"]; 
                    get_machines(site);

                }
            })
        }

        // ---------------------------------------------------------------------------------------------
        function addmachineToHtml(type, status){
            if (type == 1) {type = "wash"};
            if (type == 2) {type = "dry"};
            if (type == 3) {type = "other"};

            if (status == "0") {status = "Ava"};
            if (status == "1") {status = "UnAva"};

            let domId = type + status +"Sec";

            console.log(domId);
            $("#"+ domId).append('<img src="Resource/imgs/LM.svg" class="lm"/>');



        }

        //
        function get_machines(site){
            let washStatus = [];
            let dryStatus = [];
            let otherStatus = [];

            let url = "http://127.0.0.1:5000/dashboard?site=" + site;
            $.ajax({
                type: "POST",
                url:"http://127.0.0.1:5000/dashboard?site=" + site,
                success:function(msg){
                    for( i in msg){
                        if(i == "site"){continue;}
                        let machineId = i;
                        let status = msg[i];
                        let machineType = String(machineId)[0]; //if the first digit is a 1, it is a washer, if it is a 2, it is a drier, if it is a 3
                        
                        if(machineType == "1" && status == 0){washStatus.push(0)};
                        if(machineType == "1" && status == 1){washStatus.push(1)};
                        if(machineType == "2" && status == 0){dryStatus.push(0)};
                        if(machineType == "2" && status == 1){dryStatus.push(1)};
                        if(machineType == "3" && status == 0){otherStatus.push(0)};
                        if(machineType == "3" && status == 1){otherStatus.push(1)};

                        addmachineToHtml(machineType,status);
                    }

                    // console.log(washStatus);
                    // console.log(dryStatus);
                    // console.log(otherStatus);

                    let washPerc = washStatus.filter(x => x === 0).length/washStatus.length*100;
                    let dryPerc = dryStatus.filter(x => x === 0).length/dryStatus.length*100;
                    let otherPerc = otherStatus.filter(x => x === 0).length/otherStatus.length*100;

                    increase([washPerc,dryPerc,otherPerc]);
                }
            })
        }

        // ---------------------------------------------------------------------------------------------
        function new_machine(site,ele){
            console.log("http://127.0.0.1:5000/new-machine?time=60&site="+ site+"&type=" + ele.id);
            $.ajax({
                type: "POST",
                url:"http://127.0.0.1:5000/new-machine?time=60&site="+ site+"&type=" + ele.id,
                success:function(msg){
                    console.log(msg);
                }
            })
        }

        get_machine_helper();
    </script>

    <script type="text/javascript" src="Resource/js/script.js"></script>



</body>
</html>